// @ts-nocheck
// vim: set filetype=typescript:
describe('natural', () => {
  let options = {
    type: 'natural',
    order: 'asc',
  } as const

  it('groups all type imports together when specific type groups not configured', async () => {
    await valid({
      options: [
        {
          ...options,
          groups: [
            'type',
            ['builtin', 'external'],
            'internal',
            ['parent', 'sibling', 'index'],
          ],
        },
      ],
      code: dedent`
          import type { T } from '../t'
          import type { V } from 'v'
          import type { U } from '~/u'
        `,
    })

    await invalid({
      options: [
        {
          ...options,
          groups: [
            'type',
            ['builtin', 'external'],
            'internal',
            ['parent', 'sibling', 'index'],
          ],
        },
      ],
      code: dedent`
          import type { T } from '../t'

          import type { U } from '~/u'

          import type { V } from 'v'
        `,
      output: dedent`
          import type { T } from '../t'
          import type { V } from 'v'
          import type { U } from '~/u'
        `,
    })
  })

  it('groups style imports separately when configured', async () => {
    await valid({
      options: [
        {
          ...options,
          groups: [
            'type',
            ['builtin', 'external'],
            'internal-type',
            'internal',
            ['parent-type', 'sibling-type', 'index-type'],
            ['parent', 'sibling', 'index'],
            'style',
            'unknown',
          ],
        },
      ],
      code: dedent`
          import { a1, a2 } from 'a'

          import styles from '../s.css'
          import './t.css'
        `,
    })
  })

  it('groups side-effect imports separately when configured', async () => {
    await valid({
      options: [
        {
          ...options,
          groups: [
            'type',
            ['builtin', 'external'],
            'internal-type',
            'internal',
            ['parent-type', 'sibling-type', 'index-type'],
            ['parent', 'sibling', 'index'],
            'side-effect',
            'unknown',
          ],
        },
      ],
      code: dedent`
          import { A } from '../a'
          import { b } from './b'

          import '../c.js'
          import './d'
        `,
    })
  })

  it('groups builtin types separately from other type imports', async () => {
    await valid({
      options: [
        {
          ...options,
          groups: ['builtin-type', 'type'],
        },
      ],
      code: dedent`
          import type { Server } from 'http'

          import a from 'a'
        `,
    })
  })

  it('handles imports with semicolons correctly', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: [
            'type',
            ['builtin', 'external'],
            'internal-type',
            'internal',
            ['parent-type', 'sibling-type', 'index-type'],
            ['parent', 'sibling', 'index'],
            'unknown',
          ],
        },
      ],
      output: dedent`
          import a from 'a';

          import b from './index';
        `,
      code: dedent`
          import a from 'a';
          import b from './index';
        `,
    })
  })

  it('preserves side-effect import order when sorting disabled', async () => {
    await valid({
      options: [
        {
          ...options,
          groups: ['external', 'side-effect', 'unknown'],
          sortSideEffects: false,
        },
      ],
      code: dedent`
          import a from 'aaaa'

          import 'bbb'
          import './cc'
          import '../d'
        `,
    })

    await valid({
      options: [
        {
          ...options,
          groups: ['external', 'side-effect', 'unknown'],
          sortSideEffects: false,
        },
      ],
      code: dedent`
          import 'c'
          import 'bb'
          import 'aaa'
        `,
    })

    await invalid({
      options: [
        {
          ...options,
          groups: ['external', 'side-effect', 'unknown'],
          sortSideEffects: false,
        },
      ],
      output: dedent`
          import a from 'aaaa'
          import e from 'e'

          import './cc'
          import 'bbb'
          import '../d'
        `,
      code: dedent`
          import './cc'
          import 'bbb'
          import e from 'e'
          import a from 'aaaa'
          import '../d'
        `,
    })
  })

  it('sorts side-effect imports when sorting enabled', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['external', 'side-effect', 'unknown'],
          sortSideEffects: true,
        },
      ],
      output: dedent`
          import 'aaa'
          import 'bb'
          import 'c'
        `,
      code: dedent`
          import 'c'
          import 'bb'
          import 'aaa'
        `,
    })
  })

  it('preserves original order when side-effect imports are not grouped', async () => {
    await invalid({
      output: dedent`
          import "./z-side-effect.scss";
          import a from "./a";
          import './b-side-effect'
          import "./g-side-effect.css";
          import './a-side-effect'
          import b from "./b";
        `,
      code: dedent`
          import "./z-side-effect.scss";
          import b from "./b";
          import './b-side-effect'
          import "./g-side-effect.css";
          import './a-side-effect'
          import a from "./a";
        `,
      options: [
        {
          ...options,
          groups: ['unknown'],
        },
      ],
    })
  })

  it('groups side-effect imports together without sorting them', async () => {
    await invalid({
      output: dedent`
          import "./z-side-effect.scss";
          import './b-side-effect'
          import "./g-side-effect.css";
          import './a-side-effect'

          import a from "./a";
          import b from "./b";
        `,
      code: dedent`
          import "./z-side-effect.scss";
          import b from "./b";
          import './b-side-effect'
          import "./g-side-effect.css";
          import './a-side-effect'
          import a from "./a";
        `,
      options: [
        {
          ...options,
          groups: ['side-effect', 'unknown'],
        },
      ],
    })
  })

  it('groups side-effect and style imports together in same group without sorting', async () => {
    await invalid({
      output: dedent`
          import "./z-side-effect.scss";
          import './b-side-effect'
          import "./g-side-effect.css";
          import './a-side-effect'

          import a from "./a";
          import b from "./b";
        `,
      code: dedent`
          import "./z-side-effect.scss";
          import b from "./b";
          import './b-side-effect'
          import "./g-side-effect.css";
          import './a-side-effect'
          import a from "./a";
        `,
      options: [
        {
          ...options,
          groups: [['side-effect', 'side-effect-style'], 'unknown'],
        },
      ],
    })
  })

  it('separates side-effect and style imports into distinct groups without sorting', async () => {
    await invalid({
      output: dedent`
          import './b-side-effect'
          import './a-side-effect'

          import "./z-side-effect.scss";
          import "./g-side-effect.css";

          import a from "./a";
          import b from "./b";
        `,
      code: dedent`
          import "./z-side-effect.scss";
          import b from "./b";
          import './b-side-effect'
          import "./g-side-effect.css";
          import './a-side-effect'
          import a from "./a";
        `,
      options: [
        {
          ...options,
          groups: ['side-effect', 'side-effect-style', 'unknown'],
        },
      ],
    })
  })

  it('groups style side-effect imports separately without sorting', async () => {
    await invalid({
      output: dedent`
          import "./z-side-effect";
          import './b-side-effect.scss'
          import './a-side-effect.css'

          import "./g-side-effect";
          import a from "./a";
          import b from "./b";
        `,
      code: dedent`
          import "./z-side-effect";
          import b from "./b";
          import './b-side-effect.scss'
          import "./g-side-effect";
          import './a-side-effect.css'
          import a from "./a";
        `,
      options: [
        {
          ...options,
          groups: ['side-effect-style', 'unknown'],
        },
      ],
    })
  })

  it('ignores fallback sorting for side-effect imports', async () => {
    await valid({
      options: [
        {
          groups: ['side-effect', 'side-effect-style'],
          fallbackSort: { type: 'alphabetical' },
        },
      ],
      code: dedent`
          import 'b';
          import 'a';

          import 'b.css';
          import 'a.css';
        `,
    })
  })

  it('handles newlines and comments after fixes', async () => {
    await invalid({
      output: dedent`
          import { a } from './a' // Comment after

          import { b } from 'b'
          import { c } from 'c'
        `,
      code: dedent`
          import { b } from 'b'
          import { a } from './a' // Comment after

          import { c } from 'c'
        `,
      options: [
        {
          groups: ['unknown', 'external'],
          newlinesBetween: 'always',
        },
      ],
    })
  })

  it('supports style imports with query parameters', async () => {
    await valid({
      code: dedent`
          import b from './b.css?raw'
          import c from './c.css'

          import a from './a.js'
        `,
      options: [
        {
          ...options,
          groups: ['style', 'unknown'],
        },
      ],
    })

    await invalid({
      output: dedent`
          import b from './b.css?raw'
          import c from './c.css'

          import a from './a.js'
        `,
      code: dedent`
          import a from './a.js'
          import b from './b.css?raw'
          import c from './c.css'
        `,
      options: [
        {
          ...options,
          groups: ['style', 'unknown'],
        },
      ],
    })
  })

  it('prioritizes index types over sibling types', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['index-type', 'sibling-type'],
        },
      ],
      output: dedent`
          import type b from './index'

          import type a from './a'
        `,
      code: dedent`
          import type a from './a'

          import type b from './index'
        `,
    })
  })

  it('prioritizes specific type selectors over generic type group', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: [
            [
              'index-type',
              'internal-type',
              'external-type',
              'sibling-type',
              'builtin-type',
            ],
            'type',
          ],
        },
      ],
      output: dedent`
          import type b from './b'
          import type c from './index'
          import type d from 'd'
          import type e from 'timers'

          import type a from '../a'
        `,
      code: dedent`
          import type a from '../a'

          import type b from './b'
          import type c from './index'
          import type d from 'd'
          import type e from 'timers'
        `,
    })
  })

  it('prioritizes index imports over sibling imports', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['index', 'sibling'],
        },
      ],
      output: dedent`
          import b from './index'

          import a from './a'
        `,
      code: dedent`
          import a from './a'

          import b from './index'
        `,
    })
  })

  it('prioritizes style side-effects over generic side-effects', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['side-effect-style', 'side-effect'],
        },
      ],
      output: dedent`
          import 'style.css'

          import 'something'
        `,
      code: dedent`
          import 'something'

          import 'style.css'
        `,
    })
  })

  it('prioritizes side-effects over style imports with default exports', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['side-effect', 'style'],
        },
      ],
      output: dedent`
          import 'something'

          import style from 'style.css'
        `,
      code: dedent`
          import style from 'style.css'

          import 'something'
        `,
    })
  })

  it('prioritizes style imports over other import types', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: [
            'style',
            [
              'index',
              'internal',
              'subpath',
              'external',
              'sibling',
              'builtin',
              'parent',
              'tsconfig-path',
            ],
          ],
          tsconfigRootDir: '.',
        },
      ],
      output: dedent`
          import style from 'style.css'

          import subpath from '#subpath'
          import tsConfigPath from '$path'
          import a from '../a'
          import b from './b'
          import c from './index'
          import d from 'd'
          import e from 'timers'
        `,
      code: dedent`
          import a from '../a'
          import b from './b'
          import c from './index'
          import subpath from '#subpath'
          import tsConfigPath from '$path'
          import d from 'd'
          import e from 'timers'

          import style from 'style.css'
        `,
      before: () => {
        mockReadClosestTsConfigByPathWith({
          paths: {
            $path: ['./path'],
          },
        })
      },
    })
  })

  it('prioritizes external imports over generic import group', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['external', 'import'],
        },
      ],
      output: dedent`
          import b from 'b'

          import a from './a'
        `,
      code: dedent`
          import a from './a'

          import b from 'b'
        `,
    })
  })

  it('prioritizes side-effect imports over value imports', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['side-effect-import', 'external', 'value-import'],
          sortSideEffects: true,
        },
      ],
      output: dedent`
          import "./z"

          import f from 'f'
        `,
      code: dedent`
          import f from 'f'

          import "./z"
        `,
    })
  })

  it('prioritizes default imports over named imports', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['default-import', 'external', 'named-import'],
        },
      ],
      output: dedent`
          import z, { z } from "./z"

          import f from 'f'
        `,
      code: dedent`
          import f from 'f'

          import z, { z } from "./z"
        `,
    })
  })

  it('prioritizes wildcard imports over named imports', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['wildcard-import', 'external', 'named-import'],
        },
      ],
      output: dedent`
          import z, * as z from "./z"

          import f from 'f'
        `,
      code: dedent`
          import f from 'f'

          import z, * as z from "./z"
        `,
    })
  })

  it('treats @ symbol pattern as internal imports', async () => {
    await invalid({
      options: [
        {
          ...options,
          groups: ['external', 'internal'],
          newlinesBetween: 'always',
        },
      ],
      output: dedent`
          import { b } from 'b'

          import { a } from '@/a'
        `,
      code: dedent`
          import { b } from 'b'
          import { a } from '@/a'
        `,
    })
  })
})

describe("misc", () => {
  it("recognizes Node.js built-in modules with node: prefix", async () => {
    await valid({
      code: dedent`
          import { writeFile } from 'node:fs/promises'

          import { useEffect } from 'react'
        `,
      options: [
        {
          groups: ["builtin", "external"],
        },
      ],
    });

    await invalid({
      output: dedent`
          import { writeFile } from 'node:fs/promises'

          import { useEffect } from 'react'
        `,
      code: dedent`
          import { writeFile } from 'node:fs/promises'
          import { useEffect } from 'react'
        `,
      options: [
        {
          groups: ["builtin", "external"],
        },
      ],
    });
  });

  it("classifies internal pattern side-effects correctly by group priority", async () => {
    await valid({
      code: dedent`
          import { useClient } from '~/hooks/useClient'

          import '~/css/globals.css'

          import '~/data'
        `,
      options: [
        {
          groups: ["internal", "side-effect-style", "side-effect"],
        },
      ],
    });

    await invalid({
      output: dedent`
          import { useClient } from '~/hooks/useClient'

          import '~/css/globals.css'

          import '~/data'
        `,
      code: dedent`
          import { useClient } from '~/hooks/useClient'
          import '~/data'
          import '~/css/globals.css'
        `,
      options: [
        {
          groups: ["internal", "side-effect-style", "side-effect"],
        },
      ],
    });
  });

  it("treats empty named imports as regular imports not side-effects", async () => {
    await valid({
      code: dedent`
          import {} from 'node:os'
          import sqlite from 'node:sqlite'
          import { describe, test } from 'node:test'
          import { c } from 'c'
          import 'node:os'
        `,
      options: [
        {
          groups: ["builtin", "external", "side-effect"],
          newlinesBetween: "never",
        },
      ],
    });
  });


  describe("validates compatibility between sortSideEffects and groups configuration", () => {
    function createRule(
      groups: Options[0]["groups"],
      sortSideEffects: boolean = false,
    ): RuleListener {
      return rule.create({
        options: [
          {
            sortSideEffects,
            groups,
          },
        ],
      } as Readonly<RuleContext<MessageId, Options>>);
    }

    let expectedThrownError =
      "Side effect groups cannot be nested with non side effect groups when 'sortSideEffects' is 'false'.";

    it("throws error when side-effect group is nested with non-side-effect groups", () => {
      expect(() =>
        createRule(["external", ["side-effect", "internal"]]),
      ).toThrow(expectedThrownError);
    });

    it("throws error when side-effect-style group is nested with non-side-effect groups", () => {
      expect(() =>
        createRule(["external", ["side-effect-style", "internal"]]),
      ).toThrow(expectedThrownError);
    });

    it("throws error when mixed side-effect groups are nested with non-side-effect groups", () => {
      expect(() =>
        createRule([
          "external",
          ["side-effect-style", "internal", "side-effect"],
        ]),
      ).toThrow(expectedThrownError);
    });

    it("allows side-effect groups to be nested together", () => {
      expect(() =>
        createRule(["external", ["side-effect-style", "side-effect"]]),
      ).not.toThrow(expectedThrownError);
    });

    it("allows any group nesting when sortSideEffects is enabled", () => {
      expect(() =>
        createRule(
          ["external", ["side-effect-style", "internal", "side-effect"]],
          true,
        ),
      ).not.toThrow(expectedThrownError);
    });
  });


  it("respects ESLint disable comments when sorting imports", async () => {
    await valid({
      code: dedent`
          import { b } from "./b"
          import { c } from "./c"
          // eslint-disable-next-line
          import { a } from "./a"
        `,
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          // eslint-disable-next-line
          import { a } from './a'
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          // eslint-disable-next-line
          import { a } from './a'
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          import { a } from './a' // eslint-disable-line
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          import { a } from './a' // eslint-disable-line
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          /* eslint-disable-next-line */
          import { a } from './a'
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          /* eslint-disable-next-line */
          import { a } from './a'
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          import { a } from './a' /* eslint-disable-line */
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          import { a } from './a' /* eslint-disable-line */
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { a } from './a'
          import { d } from './d'
          /* eslint-disable */
          import { c } from './c'
          import { b } from './b'
          // Shouldn't move
          /* eslint-enable */
          import { e } from './e'
        `,
      code: dedent`
          import { d } from './d'
          import { e } from './e'
          /* eslint-disable */
          import { c } from './c'
          import { b } from './b'
          // Shouldn't move
          /* eslint-enable */
          import { a } from './a'
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          // eslint-disable-next-line rule-to-test/sort-imports
          import { a } from './a'
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          // eslint-disable-next-line rule-to-test/sort-imports
          import { a } from './a'
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          import { a } from './a' // eslint-disable-line rule-to-test/sort-imports
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          import { a } from './a' // eslint-disable-line rule-to-test/sort-imports
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          /* eslint-disable-next-line rule-to-test/sort-imports */
          import { a } from './a'
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          /* eslint-disable-next-line rule-to-test/sort-imports */
          import { a } from './a'
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { b } from './b'
          import { c } from './c'
          import { a } from './a' /* eslint-disable-line rule-to-test/sort-imports */
        `,
      code: dedent`
          import { c } from './c'
          import { b } from './b'
          import { a } from './a' /* eslint-disable-line rule-to-test/sort-imports */
        `,
      options: [{}],
    });

    await invalid({
      output: dedent`
          import { a } from './a'
          import { d } from './d'
          /* eslint-disable rule-to-test/sort-imports */
          import { c } from './c'
          import { b } from './b'
          // Shouldn't move
          /* eslint-enable */
          import { e } from './e'
        `,
      code: dedent`
          import { d } from './d'
          import { e } from './e'
          /* eslint-disable rule-to-test/sort-imports */
          import { c } from './c'
          import { b } from './b'
          // Shouldn't move
          /* eslint-enable */
          import { a } from './a'
        `,
      options: [{}],
    });
  });
});
