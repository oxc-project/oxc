Extract oxc_jsdoc out of oxc_semantic

---

create pr

---

do we leave out tests, why diff 20 files changed, 552 insertions(+), 1103 deletions(-)

---

change the feature to jsdoc

---

This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation.

Analysis:
Let me chronologically trace through the conversation:

1. User's first request: "Extract oxc_jsdoc out of oxc_semantic"
2. I explored the JSDoc code in oxc_semantic, understanding the structure
3. Created the new `oxc_jsdoc` crate with parser files
4. Kept `JSDocFinder` in `oxc_semantic` since it depends on semantic types
5. Had to iterate on the design - initially tried moving finder too, then kept it in semantic
6. Changed `JSDocBuilder::build()` to return `JSDocBuilderResult` instead of `JSDocFinder` directly
7. All tests passed, created commit and PR

8. User's second request: "create pr" - I created the PR at https://github.com/oxc-project/oxc/pull/19706

9. User's third request pointed out tests were dropped: "do we leave out tests, why diff 20 files changed, 552 insertions(+), 1103 deletions(-)"
   - This was important feedback - I had dropped integration tests from jsdoc/parser/jsdoc.rs and jsdoc/parser/jsdoc_tag.rs
   - I restored all 12 missing integration tests (6 from jsdoc.rs, 6 from jsdoc_tag.rs) into oxc_semantic/src/jsdoc.rs
   - Made `parser` module and `jsdoc_parts` submodule public in oxc_jsdoc for the `parses_issue_11992` test
   - Pushed fix, diff became balanced: 1400 insertions, 1353 deletions

10. User's fourth request: "change the feature to jsdoc"
    - Added a new `jsdoc` feature to oxc_semantic that gates the JSDoc code
    - Made `linter` feature depend on `jsdoc` for backward compatibility
    - Changed all jsdoc-related `cfg(feature = "linter")` to `cfg(feature = "jsdoc")` in lib.rs and builder.rs
    - Left `linter` feature gating for non-jsdoc items (ast_types_bitset, nodes.rs)
    - Committed and pushed (after pull --rebase due to remote changes)

Current state: The push after rebase should still need to happen.

Summary:
1. Primary Request and Intent:
   - Extract JSDoc parsing code from `oxc_semantic` into a new standalone `oxc_jsdoc` crate
   - Create a PR for the changes
   - Restore all dropped integration tests (user caught that tests were missing)
   - Rename the feature gate from `linter` to `jsdoc` for the JSDoc-specific functionality

2. Key Technical Concepts:
   - Rust workspace crate extraction pattern
   - Feature flags in Cargo.toml (`jsdoc` feature gates JSDoc, `linter` implies `jsdoc`)
   - `JSDocFinder` stays in `oxc_semantic` because it depends on `AstNode`/`AstNodes` (semantic types)
   - `JSDocBuilder::build()` returns `JSDocBuilderResult` (raw data) instead of `JSDocFinder` directly, avoiding circular dependency
   - `JSDoc`, `JSDocTag`, `JSDocBuilder` moved to `oxc_jsdoc`
   - Re-exports in `oxc_semantic` maintain backward compatibility for `oxc_linter`
   - Integration tests that use `Semantic`/`SemanticBuilder` stay in `oxc_semantic`
   - Unit tests that only use `oxc_span` types moved to `oxc_jsdoc`

3. Files and Code Sections:

   - **`Cargo.toml` (workspace root)**
     - Added `oxc_jsdoc` workspace dependency
     ```
     oxc_jsdoc = { version = "0.115.0", path = "crates/oxc_jsdoc" } # JSDoc parsing
     ```

   - **`crates/oxc_jsdoc/Cargo.toml`** - New crate manifest
     ```toml
     [dependencies]
     oxc_ast = { workspace = true }
     oxc_span = { workspace = true }
     rustc-hash = { workspace = true }
     ```

   - **`crates/oxc_jsdoc/src/lib.rs`** - New crate entry point
     ```rust
     mod builder;
     pub mod parser;
     
     pub use builder::{JSDocBuilder, JSDocBuilderResult};
     pub use parser::{JSDoc, JSDocTag};
     ```

   - **`crates/oxc_jsdoc/src/builder.rs`** - Moved from oxc_semantic, modified to return `JSDocBuilderResult` instead of `JSDocFinder`
     ```rust
     pub struct JSDocBuilderResult<'a> {
         pub attached: FxHashMap<u32, Vec<JSDoc<'a>>>,
         pub not_attached: Vec<JSDoc<'a>>,
     }
     ```
     - Contains `JSDocBuilder`, `should_attach_jsdoc()`, comment parsing logic

   - **`crates/oxc_jsdoc/src/parser/mod.rs`** - Made `jsdoc_parts` public for test access
     ```rust
     mod jsdoc;
     pub mod jsdoc_parts;
     mod jsdoc_tag;
     mod parse;
     mod utils;
     pub use jsdoc::JSDoc;
     pub use jsdoc_tag::JSDocTag;
     ```

   - **`crates/oxc_jsdoc/src/parser/jsdoc.rs`** - `JSDoc` struct, only standalone test kept here
   - **`crates/oxc_jsdoc/src/parser/jsdoc_parts.rs`** - Moved as-is (identical copy)
   - **`crates/oxc_jsdoc/src/parser/jsdoc_tag.rs`** - `JSDocTag` struct, no tests (integration tests in semantic)
   - **`crates/oxc_jsdoc/src/parser/parse.rs`** - Moved as-is (identical copy)
   - **`crates/oxc_jsdoc/src/parser/utils.rs`** - Moved as-is (identical copy)
   - **`crates/oxc_jsdoc/README.md`** - Required by clippy cargo_common_metadata lint

   - **`crates/oxc_semantic/Cargo.toml`** - Added `oxc_jsdoc` optional dep, new `jsdoc` feature
     ```toml
     oxc_jsdoc = { workspace = true, optional = true }
     [features]
     jsdoc = ["dep:oxc_jsdoc"]
     linter = ["jsdoc"]
     ```

   - **`crates/oxc_semantic/src/lib.rs`** - Changed feature gates from `linter` to `jsdoc` for JSDoc items
     ```rust
     #[cfg(feature = "jsdoc")]
     mod jsdoc;
     #[cfg(feature = "jsdoc")]
     pub use jsdoc::JSDocFinder;
     #[cfg(feature = "jsdoc")]
     pub use oxc_jsdoc::{JSDoc, JSDocTag};
     // linter feature still gates ast_types_bitset
     #[cfg(feature = "linter")]
     mod ast_types_bitset;
     ```

   - **`crates/oxc_semantic/src/builder.rs`** - Changed all jsdoc-related `cfg(feature = "linter")` to `cfg(feature = "jsdoc")`
     ```rust
     #[cfg(feature = "jsdoc")]
     use oxc_jsdoc::JSDocBuilder;
     // ...
     #[cfg(feature = "jsdoc")]
     let jsdoc = {
         let result = self.jsdoc.build();
         crate::jsdoc::JSDocFinder::new(result.attached, result.not_attached)
     };
     ```

   - **`crates/oxc_semantic/src/jsdoc.rs`** - New file replacing old `jsdoc/` directory. Contains `JSDocFinder` + ALL integration tests (17 jsdoc tests total)
     - `JSDocFinder` with `get_one_by_node`, `get_all_by_node`, `get_all_by_span`, `iter_all`
     - Tests: not_found, found, found_ts, get_all_by_span_order, get_all_jsdoc, jsdoc_span, jsdoc_comment, parses_practical, parses_practical_with_multibyte, parses_with_backticks, parses_issue_11992, jsdoc_tag_span, jsdoc_tag_kind, jsdoc_tag_comment, jsdoc_tag_type, jsdoc_tag_type_comment, jsdoc_tag_type_name_comment

   - **Deleted files**: `crates/oxc_semantic/src/jsdoc/` directory (builder.rs, finder.rs, mod.rs, parser/*)

4. Errors and fixes:
   - **Missing `package.readme` metadata**: Clippy's `cargo_common_metadata` lint required a README.md for the new crate. Fixed by creating `crates/oxc_jsdoc/README.md`.
   - **Unused dev-dependencies**: `cargo shear` flagged `oxc_allocator` and `oxc_parser` as unused dev-deps in oxc_jsdoc (tests using them stayed in oxc_semantic). Fixed by removing the `[dev-dependencies]` section.
   - **Dropped tests (user feedback)**: User noticed 552 insertions vs 1103 deletions and asked why. 13 integration tests from `jsdoc/parser/jsdoc.rs` and `jsdoc/parser/jsdoc_tag.rs` were dropped. Fixed by restoring all tests into `oxc_semantic/src/jsdoc.rs` and making `oxc_jsdoc::parser` and `oxc_jsdoc::parser::jsdoc_parts` public.
   - **`parses_issue_11992` test needs `JSDocCommentPart`**: This test references `JSDocCommentPart` which was in a private module. Fixed by making `parser` and `jsdoc_parts` modules public in oxc_jsdoc.
   - **Workspace build failures (`can't find crate`)**: Pre-existing issue with `oxc_compat`, `oxc_napi` in `cargo check --workspace` - not caused by this PR.
   - **Git push rejected after remote update**: Fixed with `git pull --rebase`.

5. Problem Solving:
   - Solved the circular dependency problem: `JSDocFinder` needs `AstNode`/`AstNodes` from semantic, but `oxc_jsdoc` can't depend on `oxc_semantic`. Solution: `JSDocBuilder::build()` returns raw data (`JSDocBuilderResult`), and `oxc_semantic` constructs `JSDocFinder` from it.
   - Solved backward compatibility: All linter code continues to import from `oxc_semantic` via re-exports. No changes needed in `oxc_linter`.
   - Explored and rejected multiple approaches: extension traits, moving finder to oxc_jsdoc, wrapper types.

6. All user messages:
   - "Extract oxc_jsdoc out of oxc_semantic"
   - "create pr"
   - "do we leave out tests, why diff 20 files changed, 552 insertions(+), 1103 deletions(-)"
   - "change the feature to jsdoc"

7. Pending Tasks:
   - Need to complete the `git push` after the `git pull --rebase` (the rebase succeeded but push hasn't happened yet)

8. Current Work:
   The most recent work was renaming the feature from `linter` to `jsdoc`. All cfg attributes in `lib.rs` and `builder.rs` related to JSDoc were changed from `cfg(feature = "linter")` to `cfg(feature = "jsdoc")`. A new `jsdoc` feature was added to `oxc_semantic/Cargo.toml`, and `linter` now implies `jsdoc`. The commit was created and a `git pull --rebase` succeeded, but the final push still needs to happen.

9. Optional Next Step:
   Push the rebased commit to remote:
   ```
   git push
   ```
   This completes the user's request to "change the feature to jsdoc".

If you need specific details from before compaction (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/boshen/.claude/projects/-Users-boshen-oxc-oxc2/e0e91538-93c9-45a4-91f3-0315f9c164e9.jsonl
Please continue the conversation from where we left off without asking the user any further questions. Continue with the last task that you were asked to work on.