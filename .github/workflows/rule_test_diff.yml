# This workflow checks that tests added in a PR for new linter rules match
# the tests that would be generated by the rulegen tool.
#
# Purpose:
#   - Validates that contributor's tests are consistent with the upstream ESLint plugin tests
#   - Helps identify missing or incorrectly formatted test cases
#   - Runs automatically when new rule files are added to the codebase
#
# When it runs:
#   1. Automatically on PRs that add new files to crates/oxc_linter/src/rules/**/*.rs
#   2. Manually via workflow_dispatch for testing with existing rules
#
# How to use manually:
#   1. Go to Actions tab -> Rule Test Diff workflow
#   2. Click "Run workflow"
#   3. Enter a rule name and plugin (e.g., "jsx-key react")
#   4. The workflow will show the diff between current tests and generated tests
#
# Example manual test input: "jsx-key react"
#
# What it does:
#   1. Detects new rule files in the PR (or uses manual input)
#   2. Backs up the current version of the rule file
#   3. Runs `just update-rule-tests <rule-name> <plugin-name>`
#   4. Shows a diff comparing the PR version vs the generated version
#   5. Restores the original file (doesn't commit changes)

name: Rule Test Diff

permissions: {}

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "crates/oxc_linter/src/rules/**/*.rs"
  workflow_dispatch:
    inputs:
      test_with_existing_rule:
        description: 'Test with an existing rule (e.g., "jsx-key react" or leave empty for normal behavior)'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-new-rules:
    name: Check Rule Test Generation
    runs-on: ubuntu-latest
    steps:
      - uses: taiki-e/checkout-action@b13d20b7cda4e2f325ef19895128f7ff735c0b3d # v1.3.1
        with:
          fetch-depth: 50  # Fetch last 50 commits to detect new files

      - name: Detect new rule files
        id: detect-new-rules
        run: |
          # Check if this is a manual test with an existing rule
          TEST_INPUT="${GITHUB_EVENT_INPUTS_TEST_WITH_EXISTING_RULE}"

          if [ -n "$TEST_INPUT" ]; then
            echo "ğŸ§ª Manual test mode enabled"
            echo "Test input: $TEST_INPUT"

            # Parse the input (expected format: "rule-name plugin-name")
            RULE_NAME=$(echo "$TEST_INPUT" | awk '{print $1}' | tr '-' '_')
            PLUGIN=$(echo "$TEST_INPUT" | awk '{print $2}')

            if [ -z "$RULE_NAME" ] || [ -z "$PLUGIN" ]; then
              echo "âŒ Invalid input format. Expected: 'rule-name plugin-name' (e.g., 'jsx-key react')"
              exit 1
            fi

            # Construct the file path
            TEST_FILE="crates/oxc_linter/src/rules/${PLUGIN}/${RULE_NAME}.rs"

            if [ ! -f "$TEST_FILE" ]; then
              echo "âŒ Test file does not exist: $TEST_FILE"
              exit 1
            fi

            echo "âœ… Testing with existing rule: $TEST_FILE"
            echo "new_files<<EOF" >> $GITHUB_OUTPUT
            echo "$TEST_FILE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_new_rules=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Normal mode: detect new files in PR
          # Get the base branch (usually main)
          BASE_REF="${GITHUB_EVENT_PULL_REQUEST_BASE_REF}"

          # Find files added in this PR in the rules directory
          NEW_RULE_FILES=$(git diff --name-only --diff-filter=A "origin/${BASE_REF}...HEAD" -- "crates/oxc_linter/src/rules/**/*.rs" | grep -v "mod.rs" || true)

          echo "Detected new rule files:"
          echo "$NEW_RULE_FILES"

          # Save to output for the next step
          echo "new_files<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_RULE_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check if there are any new files
          if [ -z "$NEW_RULE_FILES" ]; then
            echo "has_new_rules=false" >> $GITHUB_OUTPUT
          else
            echo "has_new_rules=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_EVENT_INPUTS_TEST_WITH_EXISTING_RULE: ${{ github.event.inputs.test_with_existing_rule }}
          GITHUB_EVENT_PULL_REQUEST_BASE_REF: ${{ github.event.pull_request.base.ref }}

      - uses: oxc-project/setup-rust@c8224157c0bf235aabc633e8cd50d344f087a7de # v1.0.12
        if: steps.detect-new-rules.outputs.has_new_rules == 'true'
        with:
          cache-key: rule-test-diff
          tools: just

      - name: Process each new rule
        if: steps.detect-new-rules.outputs.has_new_rules == 'true'
        run: |
          # Process each new rule file
          echo "${STEPS_DETECT_NEW_RULES_OUTPUTS_NEW_FILES}" | while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi

            echo "Processing: $file"

            # Extract plugin name from directory structure
            # Example: crates/oxc_linter/src/rules/react/jsx_key.rs -> react
            plugin=$(echo "$file" | sed -n 's|crates/oxc_linter/src/rules/\([^/]*\)/.*|\1|p')

            # Extract rule name from filename (remove .rs extension)
            # Example: jsx_key.rs -> jsx_key
            rule_name=$(basename "$file" .rs)

            echo "  Rule: $rule_name"
            echo "  Plugin: $plugin"

            # Skip if we couldn't extract the plugin or rule name
            if [ -z "$plugin" ] || [ -z "$rule_name" ]; then
              echo "  âš ï¸ Could not extract plugin or rule name from: $file"
              continue
            fi

            # Create a backup of the current file
            cp "$file" "${file}.backup"

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“ Regenerating tests for: $rule_name ($plugin)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # Run the update-rule-tests command
            just update-rule-tests "$rule_name" "$plugin" || {
              echo "  âš ï¸ Failed to run update-rule-tests for $rule_name"
              # Restore the backup
              mv "${file}.backup" "$file"
              continue
            }

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Diff: PR version vs Generated version"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Comparing:"
            echo "  - PR version:        $file (from backup)"
            echo "  - Generated version: $file (just regenerated)"
            echo ""

            # Show the diff between the backup (PR version) and the regenerated version
            if diff -u "${file}.backup" "$file" > /dev/null 2>&1; then
              echo "âœ… No differences found! The tests in the PR match the generated tests."
            else
              echo "âš ï¸ Differences found between PR version and generated version:"
              echo ""
              diff -u "${file}.backup" "$file" || true
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # Restore the original file (PR version)
            mv "${file}.backup" "$file"
          done
        env:
          STEPS_DETECT_NEW_RULES_OUTPUTS_NEW_FILES: ${{ steps.detect-new-rules.outputs.new_files }}
