# This workflow checks that tests added in a PR for new linter rules match
# the tests that would be generated by the rulegen tool.
#
# Purpose:
#   - Validates that contributor's tests are consistent with the upstream ESLint plugin tests
#   - Helps identify missing or incorrectly formatted test cases
#   - Runs automatically when new rule files are added to the codebase
#
# When it runs:
#   1. Automatically on PRs that add new files to crates/oxc_linter/src/rules/**/*.rs
#
# What it does:
#   1. Detects new rule files in the PR
#   2. Backs up the current version of the rule file
#   3. Runs `just update-rule-tests <rule-name> <plugin-name>`
#   4. Shows a diff comparing the PR version vs the generated version

name: Rule Test Diff

permissions: {}

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "crates/oxc_linter/src/rules/**/*.rs"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-new-rules:
    name: Check Rule Test Generation
    runs-on: ubuntu-latest
    steps:
      - uses: taiki-e/checkout-action@b13d20b7cda4e2f325ef19895128f7ff735c0b3d # v1.3.1

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          list-files: shell
          filters: |
            rules:
              - added: 'crates/oxc_linter/src/rules/**/*.rs'

      - name: Detect new rule files
        id: detect-new-rules
        run: |
          # Use dorny/paths-filter outputs for added rule files
          NEW_RULE_FILES="${STEPS_FILTER_OUTPUTS_RULES_ADDED_FILES}"

          # Only proceed when exactly one file was added; otherwise bail out
          FILE_COUNT=$(echo "$NEW_RULE_FILES" | sed '/^$/d' | wc -l | tr -d ' ')
          if [ "$FILE_COUNT" -gt 1 ]; then
            echo "⚠️ More than one new rule file detected; skipping"
            echo "new_files<<EOF" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_new_rules=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Detected new rule files:"
          echo "$NEW_RULE_FILES"

          # Save to output for the next step
          echo "new_files<<EOF" >> $GITHUB_OUTPUT
          echo "$NEW_RULE_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Check if there are any new files
          if [ -z "$NEW_RULE_FILES" ]; then
            echo "has_new_rules=false" >> $GITHUB_OUTPUT
          else
            echo "has_new_rules=true" >> $GITHUB_OUTPUT
          fi
        env:
          STEPS_FILTER_OUTPUTS_RULES_ADDED_FILES: ${{ steps.filter.outputs.rules_files }}

      - uses: oxc-project/setup-rust@c8224157c0bf235aabc633e8cd50d344f087a7de # v1.0.12
        if: steps.detect-new-rules.outputs.has_new_rules == 'true'
        with:
          cache-key: rule-test-diff
          tools: just
          components: rustfmt

      - name: Regenerate tests for new rule
        if: steps.detect-new-rules.outputs.has_new_rules == 'true'
        run: |
          echo "${STEPS_DETECT_NEW_RULES_OUTPUTS_NEW_FILES}" | while IFS= read -r file; do
            [ -z "$file" ] && continue

            echo "Regenerating: $file"

            plugin_raw=$(echo "$file" | sed -n 's|crates/oxc_linter/src/rules/\([^/]*\)/.*|\1|p')
            plugin=${plugin_raw//_/-}
            rule_name=$(basename "$file" .rs)

            if [ -z "$plugin" ] || [ -z "$rule_name" ]; then
              echo "⚠️ Could not extract plugin or rule name from: $file"
              exit 1
            fi

            cp "$file" "${file}.backup"

            just update-rule-tests "$rule_name" "$plugin" || {
              echo "⚠️ Failed to run update-rule-tests for $rule_name; restoring backup"
              mv "${file}.backup" "$file"
              exit 1
            }
          done
        env:
          STEPS_DETECT_NEW_RULES_OUTPUTS_NEW_FILES: ${{ steps.detect-new-rules.outputs.new_files }}

      - name: Diff regenerated tests vs PR
        if: steps.detect-new-rules.outputs.has_new_rules == 'true'
        run: |
          echo "${STEPS_DETECT_NEW_RULES_OUTPUTS_NEW_FILES}" | while IFS= read -r file; do
            [ -z "$file" ] && continue

            if [ ! -f "${file}.backup" ]; then
              echo "❌ Missing backup for $file"
              exit 1
            fi

            echo "Comparing: $file"
            echo "  - PR version:        ${file}.backup"
            echo "  - Generated version: $file"

            # Show color diff for clarity
            if git diff --no-index --color=always "${file}.backup" "$file" > /tmp/rule_diff.out; then
              if [ ! -s /tmp/rule_diff.out ]; then
                echo "✅ No differences found!"
              else
                cat /tmp/rule_diff.out
              fi
            else
              cat /tmp/rule_diff.out || true
            fi
          done
        env:
          STEPS_DETECT_NEW_RULES_OUTPUTS_NEW_FILES: ${{ steps.detect-new-rules.outputs.new_files }}
