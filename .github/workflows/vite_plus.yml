name: Vite Plus

permissions: {}

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */4 * * *" # Every 4 hours.

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ github.ref_name != 'main' }}

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
          - os: windows-latest
    name: Test
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    permissions:
      contents: read
      packages: read
    steps:
      - uses: taiki-e/checkout-action@afad4df3ab3122b166e8226ac83be4d981fb64e8 # v1.3.2

      - uses: oxc-project/setup-node@8958a8e040102244b619c4a94fccb657a44b1c21 # v1.0.6

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .node-version
          registry-url: "https://npm.pkg.github.com"
          scope: "@voidzero-dev"
          package-manager-cache: false

      # - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # 2.0.2
      # with:
      # bun-version: latest
      # registries: |
      # https://registry.npmjs.org/
      # @voidzero-dev:https://npm.pkg.github.com/|$GITHUB_TOKEN

      # - run: bun install -g @voidzero-dev/global@latest
      # env:
      # NODE_AUTH_TOKEN: ${{ secrets.VP_TOKEN }}

      - run: npm install -g @voidzero-dev/global@latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.VP_TOKEN }}

      - uses: actions/cache/restore@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          key: vp
          path: ./node_modules/.vite/task-cache

      - uses: oxc-project/setup-rust@c8224157c0bf235aabc633e8cd50d344f087a7de # v1.0.12
        with:
          cache-key: napi
          save-cache: false

      - run: vite --version

      - run: rustup target add wasm32-wasip1-threads
      - run: vite run ready
      - run: vite run ready # Run second time to test cache

      - uses: actions/cache/save@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          key: vp
          path: ./node_modules/.vite/task-cache
